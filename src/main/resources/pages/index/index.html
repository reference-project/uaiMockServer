<!DOCTYPE html>
<html lang="en" ng-app="uaiMockServerApp">
    <head>
        <meta charset="utf-8">
        <link rel="icon" type="image/x-icon" href="/uai-mock-server-gui/favicon" />

        <link rel="stylesheet" href="/uai-mock-server-gui/css?fileName=bootstrap" />
        <link rel="stylesheet" href="/uai-mock-server-gui/css?fileName=tableSort" />
        <link rel="stylesheet" href="/uai-mock-server-gui/css?fileName=index" />
        <link rel="stylesheet" href="/uai-mock-server-gui/css?fileName=growl" />

        <script type="application/javascript" src="/uai-mock-server-gui/javascript?fileName=angular"></script>
        <script type="application/javascript" src="/uai-mock-server-gui/javascript?fileName=angular-animate"></script>
        <script type="application/javascript" src="/uai-mock-server-gui/javascript?fileName=tableSort"></script>
        <script type="application/javascript" src="/uai-mock-server-gui/javascript?fileName=jquery"></script>
        <script type="application/javascript" src="/uai-mock-server-gui/javascript?fileName=bootstrap"></script>
        <script type="application/javascript" src="/uai-mock-server-gui/javascript?fileName=angular-growl"></script>
        <script type="application/javascript" src="/uai-mock-server-gui/javascript?fileName=angular-sanitize"></script>

        <title>
            UaiMockServer - GUI
        </title>
    </head>
    <body ng-controller="routeController" class="container">
        <div ng-include="'/uai-mock-server-gui/page?fileName=common/headerMenu'"></div>

        <div ng-include="'/uai-mock-server-gui/page?fileName=index/indexTable'"></div>

        <div ng-include="'/uai-mock-server-gui/page?fileName=index/routeDialog'"></div>

        <div ng-include="'/uai-mock-server-gui/page?fileName=index/deleteDialog'"></div>

        <button type="button" class="btn btn-primary" ng-click="displayCreateNew()">Create New</button>

        <div growl></div>
    </body>
    <script>
        var app = angular.module('uaiMockServerApp', ['tableSort', 'angular-growl', 'ngAnimate']);

        app.config(['growlProvider', function(growlProvider) {
            growlProvider.globalTimeToLive(1500);
        }]);

        app.controller('routeController', function($scope, $http, growl) {
            $scope.items = [{name: 'one', age: 30 },{ name: 'two', age: 27 },{ name: 'three', age: 50 }];
            $scope.loadTable = function(){
                $http.get('/uai-mock-server-gui/uaiRoute').
                        success(function(data) {
                            $scope.routeRowList = [];
                            $scope.mainConfigFilePath = data.mainConfigFile;
                            $scope.httpMethodArray = data.httpMethodArray;

                            for (var i = 0; i < data.routeList.length; i++) {
                                var routeRow = {};

                                routeRow.requestName = data.routeList[i].request.name;
                                routeRow.requestMethod = data.routeList[i].request.method;
                                routeRow.requestPath = data.routeList[i].request.path;
                                routeRow.responseCode = data.routeList[i].response.statusCode;
                                routeRow.responseContentType = data.routeList[i].response.contentType;

                                routeRow.route = data.routeList[i];

                                $scope.routeRowList.push(routeRow);
                            }
                        }
                );
            }

            $scope.loadTable();

            $scope.getErrorText = function(route) {
                var hasError = false;
                var errorHtml = "<ul>";

                if (route.request.name == null || route.request.name.trim() == "") {
                    hasError = true;
                    errorHtml += "<li>request.name was not found</li>";
                }

                if (route.request.path == null || route.request.path.trim() == "") {
                    hasError = true;
                    errorHtml += "<li>request.path was not found</li>";
                }

                if (route.request.method == null || route.request.method.trim() == "") {
                    hasError = true;
                    errorHtml += "<li>request.method was not found</li>";
                }

                if (route.response.statusCode == null || route.response.statusCode <= 0) {
                    hasError = true;
                    errorHtml += "<li>response.statusCode was not found</li>";
                }

                if (hasError) {
                    errorHtml += "</ul>";
                    return errorHtml;
                }

                return null;
            }

            $scope.saveRoute = function() {
                $scope.convertStringToList($scope.selectedRouteRow.route.request.requiredHeaderList);
                $scope.convertStringToList($scope.selectedRouteRow.route.request.requiredQueryParamList);
                $scope.convertStringToList($scope.selectedRouteRow.route.response.headerList);

                var errorText = $scope.getErrorText($scope.selectedRouteRow.route);

                if (errorText != null) {
                    $scope.hasValidationErrors = true;
                    $('#errorDiv').html(errorText);
                    return;
                }

                if ($scope.action === 'update') {
                    $http.put('/uai-mock-server-gui/uaiRoute', $scope.selectedRouteRow.route).
                            success(function(data) {
                                $scope.loadTable();
                                $('#routeModal').modal('toggle');
                                $scope.displaySuccessGrowl();
                            }
                    );
                } else {
                    $http.post('/uai-mock-server-gui/uaiRoute', $scope.selectedRouteRow.route).
                            success(function(data) {
                                $scope.loadTable();
                                $('#routeModal').modal('toggle');
                                $scope.displaySuccessGrowl();
                            }
                    );
                }

            }

            $scope.displaySuccessGrowl = function() {
                growl.addSuccessMessage("Operation Confirmed (:");
            }

            $scope.convertStringToList = function(requiredHeaderList) {
                if (requiredHeaderList == null) {
                    return;
                }

                for (var i = 0; i < requiredHeaderList.length; i++) {
                    if (typeof requiredHeaderList[i].valueList === "string") {
                        requiredHeaderList[i].valueList = requiredHeaderList[i].valueList.split(",");
                    }
                }
            }

            $scope.displaySelected = function (routeRow) {
                $scope.hasValidationErrors = false;
                $scope.action = 'update';

                $scope.selectedRouteRow = {};
                angular.copy(routeRow, $scope.selectedRouteRow);

                $('#myTab a:first').tab('show')
                $('#routeModal').modal('toggle');
            }

            $scope.displayCreateNew = function () {
                $scope.action = 'create';
                $scope.hasValidationErrors = false;
                $scope.selectedRouteRow = {};
                $scope.selectedRouteRow.route = {};
                $scope.selectedRouteRow.route.request = {};
                $scope.selectedRouteRow.route.request.requiredHeaderList = [];
                $scope.selectedRouteRow.route.request.requiredQueryParamList = [];
                $scope.selectedRouteRow.route.response = {};
                $scope.selectedRouteRow.route.response = {};
                $scope.selectedRouteRow.route.response.headerList = [];
                $scope.selectedRouteRow.route.uaiFile = {};
                $scope.selectedRouteRow.route.uaiFile.fullPath = $scope.mainConfigFilePath;

                $('#myTab a:first').tab('show')
                $('#routeModal').modal('toggle');
            }

            $scope.deleteSelectedConfirmation = function () {
                $scope.action = 'delete';
                $('#routeModal').modal('toggle');
                $('#deleteRouteModal').modal('toggle');
            }

            $scope.cancelDelete = function () {
                $('#deleteRouteModal').modal('toggle');
                $('#routeModal').modal('toggle');
            }

            $scope.delete = function () {
                $http.delete('/uai-mock-server-gui/uaiRoute?routeId='+$scope.selectedRouteRow.route.id).
                        success(function(data) {
                            $scope.loadTable();
                            $('#deleteRouteModal').modal('toggle');
                            $scope.displaySuccessGrowl();
                        }
                );
            }
        });
    </script>
</html>