<!DOCTYPE html>
<html lang="en" ng-app="uaiMockServerApp">
    <head>
        <meta charset="utf-8">
        <link rel="icon" type="image/x-icon" href="/uai-mock-server-gui/favicon" />

        <link rel="stylesheet" href="/uai-mock-server-gui/css?fileName=bootstrap" />
        <link rel="stylesheet" href="/uai-mock-server-gui/css?fileName=tableSort" />
        <link rel="stylesheet" href="/uai-mock-server-gui/css?fileName=index" />

        <script type="application/javascript" src="/uai-mock-server-gui/javascript?fileName=angular"></script>
        <script type="application/javascript" src="/uai-mock-server-gui/javascript?fileName=tableSort"></script>
        <script type="application/javascript" src="/uai-mock-server-gui/javascript?fileName=jquery"></script>
        <script type="application/javascript" src="/uai-mock-server-gui/javascript?fileName=bootstrap"></script>
        <title>
            UaiMockServer - GUI
        </title>
    </head>
    <body ng-controller="routeController" class="container">
        <div ng-include="'/uai-mock-server-gui/page?fileName=common/headerMenu'"></div>

        <div ng-include="'/uai-mock-server-gui/page?fileName=index/indexTable'"></div>

        <div ng-include="'/uai-mock-server-gui/page?fileName=index/routeDialog'"></div>

        <div ng-include="'/uai-mock-server-gui/page?fileName=index/deleteDialog'"></div>
    </body>
    <script>
        var app = angular.module('uaiMockServerApp', ['tableSort']);

        app.controller('routeController', function($scope, $http) {

            $scope.loadTable = function(){
                $http.get('/uai-mock-server-gui/uaiRoute').
                        success(function(data) {
                            $scope.routeRowList = [];

                            for (var i = 0; i < data.routeList.length; i++) {
                                var routeRow = {};

                                routeRow.requestName = data.routeList[i].request.name;
                                routeRow.requestMethod = data.routeList[i].request.method;
                                routeRow.requestPath = data.routeList[i].request.path;
                                routeRow.responseCode = data.routeList[i].response.statusCode;
                                routeRow.responseContentType = data.routeList[i].response.contentType;

                                routeRow.route = data.routeList[i];

                                $scope.routeRowList.push(routeRow);
                            }
                        }
                );
            }

            $scope.loadTable();

            $scope.saveRoute = function(updatedRouteRow) {
                $scope.convertStringToList(updatedRouteRow.route.request.requiredHeaderList);
                $scope.convertStringToList(updatedRouteRow.route.request.requiredQueryParamList);
                $scope.convertStringToList(updatedRouteRow.route.response.headerList);

                $http.post('/uai-mock-server-gui/uaiRoute', updatedRouteRow.route).
                        success(function(data) {
                            $scope.loadTable();
                            $('#routeModal').modal('toggle');
                        }
                );
            }

            $scope.convertStringToList = function(requiredHeaderList) {
                if (requiredHeaderList == null) {
                    return;
                }

                for (var i = 0; i < requiredHeaderList.length; i++) {
                    if (typeof requiredHeaderList[i].valueList === "string") {
                        requiredHeaderList[i].valueList = requiredHeaderList[i].valueList.split(",");
                    }
                }
            }

            $scope.displaySelected = function (routeRow) {
                $scope.selectedRouteRow = {};
                angular.copy(routeRow, $scope.selectedRouteRow);

                $('#myTab a:first').tab('show')
                $('#routeModal').modal('toggle');
            }

            $scope.deleteSelectedConfirmation = function () {
                $('#routeModal').modal('toggle');
                $('#deleteRouteModal').modal('toggle');
            }

            $scope.cancelDelete = function () {
                $('#deleteRouteModal').modal('toggle');
                $('#routeModal').modal('toggle');
            }

            $scope.delete = function () {
                $http.delete('/uai-mock-server-gui/uaiRoute?routeId='+$scope.selectedRouteRow.route.id).
                        success(function(data) {
                            $scope.loadTable();
                            $('#deleteRouteModal').modal('toggle');
                        }
                );
            }
        });
    </script>
</html>